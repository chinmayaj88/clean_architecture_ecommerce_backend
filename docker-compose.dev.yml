services:
  # PostgreSQL database for auth-service
  postgres-auth:
    image: postgres:16-alpine
    container_name: postgres-auth
    environment:
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_pass
      POSTGRES_DB: auth_db
    ports:
      - "5433:5432"
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # PostgreSQL database for user-service
  postgres-user:
    image: postgres:16-alpine
    container_name: postgres-user
    environment:
      POSTGRES_USER: user_user
      POSTGRES_PASSWORD: user_pass
      POSTGRES_DB: user_db
    ports:
      - "5435:5432"
    volumes:
      - postgres-user-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # PostgreSQL database for product-service
  postgres-product:
    image: postgres:16-alpine
    container_name: postgres-product
    environment:
      POSTGRES_USER: product_user
      POSTGRES_PASSWORD: product_pass
      POSTGRES_DB: product_db
    ports:
      - "5434:5432"
    volumes:
      - postgres-product-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U product_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # PostgreSQL database for cart-service
  postgres-cart:
    image: postgres:16-alpine
    container_name: postgres-cart
    environment:
      POSTGRES_USER: cart_user
      POSTGRES_PASSWORD: cart_pass
      POSTGRES_DB: cart_db
    ports:
      - "5436:5432"
    volumes:
      - postgres-cart-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cart_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # PostgreSQL database for order-service
  postgres-order:
    image: postgres:16-alpine
    container_name: postgres-order
    environment:
      POSTGRES_USER: order_user
      POSTGRES_PASSWORD: order_pass
      POSTGRES_DB: order_db
    ports:
      - "5437:5432"
    volumes:
      - postgres-order-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U order_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # PostgreSQL database for payment-service
  postgres-payment:
    image: postgres:16-alpine
    container_name: postgres-payment
    environment:
      POSTGRES_USER: payment_user
      POSTGRES_PASSWORD: payment_pass
      POSTGRES_DB: payment_db
    ports:
      - "5438:5432"
    volumes:
      - postgres-payment-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U payment_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # PostgreSQL database for notification-service
  postgres-notification:
    image: postgres:16-alpine
    container_name: postgres-notification
    environment:
      POSTGRES_USER: notification_user
      POSTGRES_PASSWORD: notification_pass
      POSTGRES_DB: notification_db
    ports:
      - "5439:5432"
    volumes:
      - postgres-notification-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U notification_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # PostgreSQL database for discount-service
  postgres-discount:
    image: postgres:16-alpine
    container_name: postgres-discount
    environment:
      POSTGRES_USER: discount_user
      POSTGRES_PASSWORD: discount_pass
      POSTGRES_DB: discount_db
    ports:
      - "5440:5432"
    volumes:
      - postgres-discount-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U discount_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # PostgreSQL database for shipping-service
  postgres-shipping:
    image: postgres:16-alpine
    container_name: postgres-shipping
    environment:
      POSTGRES_USER: shipping_user
      POSTGRES_PASSWORD: shipping_pass
      POSTGRES_DB: shipping_db
    ports:
      - "5441:5432"
    volumes:
      - postgres-shipping-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shipping_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # PostgreSQL database for return-service
  postgres-return:
    image: postgres:16-alpine
    container_name: postgres-return
    environment:
      POSTGRES_USER: return_user
      POSTGRES_PASSWORD: return_pass
      POSTGRES_DB: return_db
    ports:
      - "5442:5432"
    volumes:
      - postgres-return-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U return_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # Redis for caching and distributed rate limiting
  redis:
    image: redis:7.4-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecommerce-network

  # LocalStack for AWS services emulation (SNS/SQS)
  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    environment:
      - SERVICES=sns,sqs
      - DEBUG=0
      - DATA_DIR=/var/lib/localstack
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PERSISTENCE=1
    ports:
      - "4566:4566"  # LocalStack Edge Port
      - "4510-4559:4510-4559"  # External services port range
    volumes:
      - localstack-data:/var/lib/localstack
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Adminer - Web-based database management tool
  adminer:
    image: adminer:latest
    container_name: adminer
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres-auth
    depends_on:
      - postgres-auth
      - postgres-user
      - postgres-product
      - postgres-cart
      - postgres-order
      - postgres-payment
      - postgres-notification
      - postgres-discount
      - postgres-shipping
      - postgres-return
    networks:
      - ecommerce-network

volumes:
  postgres-auth-data:
  postgres-user-data:
  postgres-product-data:
  postgres-cart-data:
  postgres-order-data:
  postgres-payment-data:
  postgres-notification-data:
  postgres-discount-data:
  postgres-shipping-data:
  postgres-return-data:
  redis-data:
  localstack-data:

networks:
  ecommerce-network:
    driver: bridge

