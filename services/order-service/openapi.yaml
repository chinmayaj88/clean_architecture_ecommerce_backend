openapi: 3.0.0
info:
  title: Order Service API
  description: Order management service for the e-commerce platform
  version: 1.0.0
  contact:
    name: API Support
    email: support@ecommerce.com

servers:
  - url: http://localhost:3005
    description: Local development server
  - url: https://api.ecommerce.com
    description: Production server

tags:
  - name: Orders
    description: Order management operations
  - name: Order Notes
    description: Order notes management

paths:
  /api/v1/orders:
    post:
      tags:
        - Orders
      summary: Create a new order from cart
      description: Creates a new order from the user's cart
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                cartId:
                  type: string
                  description: Optional cart ID (uses user's active cart if not provided)
                shippingAddressId:
                  type: string
                  description: Optional shipping address ID (uses default if not provided)
                paymentMethodId:
                  type: string
                  description: Payment method ID
                shippingMethod:
                  type: string
                  description: Shipping method
              example:
                cartId: "clx1234567890"
                shippingAddressId: "addr1234567890"
                paymentMethodId: "pm_1234567890"
                shippingMethod: "standard"
      responses:
        '201':
          description: Order created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '500':
          description: Internal server error

    get:
      tags:
        - Orders
      summary: Get user's orders
      description: Retrieve orders for the authenticated user with optional filtering and pagination
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, confirmed, processing, shipped, delivered, cancelled, refunded]
          description: Filter by order status
        - name: paymentStatus
          in: query
          schema:
            type: string
            enum: [pending, paid, failed, refunded]
          description: Filter by payment status
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of orders per page
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of orders to skip
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [createdAt, totalAmount, status]
            default: createdAt
          description: Field to sort by
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: Sort order
        - name: startDate
          in: query
          schema:
            type: string
            format: date-time
          description: Filter orders from this date
        - name: endDate
          in: query
          schema:
            type: string
            format: date-time
          description: Filter orders until this date
        - name: minAmount
          in: query
          schema:
            type: number
            minimum: 0
          description: Minimum order amount
        - name: maxAmount
          in: query
          schema:
            type: number
            minimum: 0
          description: Maximum order amount
      responses:
        '200':
          description: Orders retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    oneOf:
                      - type: array
                        items:
                          $ref: '#/components/schemas/Order'
                      - $ref: '#/components/schemas/PaginatedOrders'
        '401':
          description: Unauthorized
        '500':
          description: Internal server error

  /api/v1/orders/{orderId}:
    get:
      tags:
        - Orders
      summary: Get order by ID
      description: Retrieve a specific order by its ID
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
          description: Order ID
      responses:
        '200':
          description: Order retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetailsResponse'
        '404':
          description: Order not found
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

    patch:
      tags:
        - Orders
      summary: Update order status
      description: Update the status of an order
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [pending, confirmed, processing, shipped, delivered, cancelled, refunded]
                reason:
                  type: string
                  description: Reason for status change
      responses:
        '200':
          description: Order status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Order not found

  /api/v1/orders/{orderId}/payment-status:
    patch:
      tags:
        - Orders
      summary: Update payment status
      description: Update the payment status of an order
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - paymentStatus
              properties:
                paymentStatus:
                  type: string
                  enum: [pending, paid, failed, refunded]
                reason:
                  type: string
                  description: Reason for payment status change
      responses:
        '200':
          description: Payment status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Order not found

  /api/v1/orders/{orderId}/cancel:
    post:
      tags:
        - Orders
      summary: Cancel an order
      description: Cancel an order (only if it's in pending or confirmed status)
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Reason for cancellation
      responses:
        '200':
          description: Order cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Bad request (order cannot be cancelled)
        '401':
          description: Unauthorized
        '404':
          description: Order not found

  /api/v1/orders/number/{orderNumber}:
    get:
      tags:
        - Orders
      summary: Get order by order number
      description: Retrieve a specific order by its order number
      security:
        - bearerAuth: []
      parameters:
        - name: orderNumber
          in: path
          required: true
          schema:
            type: string
          description: Order number
      responses:
        '200':
          description: Order retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetailsResponse'
        '404':
          description: Order not found
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /api/v1/orders/{orderId}/notes:
    post:
      tags:
        - Order Notes
      summary: Create an order note
      description: Add a note to an order (internal or customer-facing)
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - note
              properties:
                note:
                  type: string
                  description: Note content
                isInternal:
                  type: boolean
                  default: false
                  description: Whether this is an internal note (not visible to customer)
      responses:
        '201':
          description: Order note created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderNoteResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Order not found

    get:
      tags:
        - Order Notes
      summary: Get order notes
      description: Retrieve all notes for an order
      security:
        - bearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
        - name: includeInternal
          in: query
          schema:
            type: boolean
            default: false
          description: Include internal notes
      responses:
        '200':
          description: Order notes retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrderNote'
        '401':
          description: Unauthorized
        '404':
          description: Order not found

  /api/v1/orders/notes/{noteId}:
    patch:
      tags:
        - Order Notes
      summary: Update an order note
      description: Update an existing order note
      security:
        - bearerAuth: []
      parameters:
        - name: noteId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - note
              properties:
                note:
                  type: string
                  description: Updated note content
      responses:
        '200':
          description: Order note updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderNoteResponse'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '404':
          description: Order note not found

    delete:
      tags:
        - Order Notes
      summary: Delete an order note
      description: Delete an order note
      security:
        - bearerAuth: []
      parameters:
        - name: noteId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Order note deleted successfully
        '401':
          description: Unauthorized
        '404':
          description: Order note not found

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Order:
      type: object
      properties:
        id:
          type: string
        orderNumber:
          type: string
        userId:
          type: string
        status:
          type: string
          enum: [pending, confirmed, processing, shipped, delivered, cancelled, refunded]
        paymentStatus:
          type: string
          enum: [pending, paid, failed, refunded]
        subtotal:
          type: number
          format: double
        taxAmount:
          type: number
          format: double
        shippingAmount:
          type: number
          format: double
        discountAmount:
          type: number
          format: double
        totalAmount:
          type: number
          format: double
        currency:
          type: string
          default: USD
        paymentMethodId:
          type: string
          nullable: true
        shippingMethod:
          type: string
          nullable: true
        trackingNumber:
          type: string
          nullable: true
        estimatedDeliveryDate:
          type: string
          format: date-time
          nullable: true
        shippedAt:
          type: string
          format: date-time
          nullable: true
        deliveredAt:
          type: string
          format: date-time
          nullable: true
        cancelledAt:
          type: string
          format: date-time
          nullable: true
        metadata:
          type: object
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    OrderItem:
      type: object
      properties:
        id:
          type: string
        orderId:
          type: string
        productId:
          type: string
        variantId:
          type: string
          nullable: true
        productName:
          type: string
        productSku:
          type: string
        productImageUrl:
          type: string
          nullable: true
        unitPrice:
          type: number
          format: double
        quantity:
          type: integer
        totalPrice:
          type: number
          format: double
        createdAt:
          type: string
          format: date-time

    OrderShippingAddress:
      type: object
      properties:
        id:
          type: string
        orderId:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        company:
          type: string
          nullable: true
        addressLine1:
          type: string
        addressLine2:
          type: string
          nullable: true
        city:
          type: string
        state:
          type: string
        postalCode:
          type: string
        country:
          type: string
        phone:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time

    OrderStatusHistory:
      type: object
      properties:
        id:
          type: string
        orderId:
          type: string
        status:
          type: string
        previousStatus:
          type: string
          nullable: true
        changedBy:
          type: string
        reason:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time

    OrderNote:
      type: object
      properties:
        id:
          type: string
        orderId:
          type: string
        note:
          type: string
        createdBy:
          type: string
        isInternal:
          type: boolean
        createdAt:
          type: string
          format: date-time

    OrderDetails:
      type: object
      properties:
        order:
          $ref: '#/components/schemas/Order'
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        shippingAddress:
          $ref: '#/components/schemas/OrderShippingAddress'
          nullable: true
        statusHistory:
          type: array
          items:
            $ref: '#/components/schemas/OrderStatusHistory'

    PaginatedOrders:
      type: object
      properties:
        orders:
          type: array
          items:
            $ref: '#/components/schemas/Order'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer
        hasMore:
          type: boolean

    OrderResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          $ref: '#/components/schemas/Order'
        timestamp:
          type: string
          format: date-time

    OrderDetailsResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          $ref: '#/components/schemas/OrderDetails'
        timestamp:
          type: string
          format: date-time

    OrderNoteResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          $ref: '#/components/schemas/OrderNote'
        timestamp:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
        error:
          type: string
        timestamp:
          type: string
          format: date-time

