openapi: 3.0.3
info:
  title: Notification Service API
  description: Notification service API (consumes events, sends notifications)
  version: 1.0.0

servers:
  - url: http://localhost:3007/api/v1
    description: Local development server

paths:
  /health:
    get:
      summary: Health check
      responses:
        '200':
          description: Service is healthy

  /notifications:
    post:
      summary: Send a notification
      description: Send a notification (email, SMS, push, or in-app)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
                - type
                - body
              properties:
                userId:
                  type: string
                  description: User ID to send notification to
                type:
                  type: string
                  enum: [EMAIL, SMS, PUSH, IN_APP]
                  description: Notification type
                subject:
                  type: string
                  description: Notification subject (for emails)
                body:
                  type: string
                  description: Notification body/content
                bodyHtml:
                  type: string
                  description: HTML body (for emails)
                bodyText:
                  type: string
                  description: Plain text body (for emails)
                metadata:
                  type: object
                  description: Additional metadata (e.g., email, phone number)
                scheduledAt:
                  type: string
                  format: date-time
                  description: Scheduled send time (optional)
                checkPreferences:
                  type: boolean
                  description: Check user preferences before sending (default: true)
                notificationType:
                  type: string
                  description: Notification category for preference checking
      responses:
        '201':
          description: Notification sent successfully
        '400':
          description: Invalid request
        '500':
          description: Server error

  /notifications/{id}:
    get:
      summary: Get notification by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Notification retrieved successfully
        '404':
          description: Notification not found
        '500':
          description: Server error

  /notifications/{id}/retry:
    post:
      summary: Retry a failed notification
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Notification retry initiated successfully
        '400':
          description: Notification cannot be retried
        '404':
          description: Notification not found
        '500':
          description: Server error

  /notifications/user/{userId}:
    get:
      summary: Get notifications by user ID
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: query
          schema:
            type: string
            enum: [EMAIL, SMS, PUSH, IN_APP]
        - name: status
          in: query
          schema:
            type: string
            enum: [PENDING, SENT, DELIVERED, FAILED, BOUNCED]
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Notifications retrieved successfully
        '500':
          description: Server error

  /templates:
    post:
      summary: Create an email template
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - subject
                - bodyHtml
              properties:
                name:
                  type: string
                  description: Template name (unique)
                subject:
                  type: string
                  description: Email subject
                bodyHtml:
                  type: string
                  description: HTML body
                bodyText:
                  type: string
                  description: Plain text body (optional)
                variables:
                  type: object
                  description: Template variables
                isActive:
                  type: boolean
                  description: Whether template is active
                  default: true
      responses:
        '201':
          description: Template created successfully
        '400':
          description: Invalid request
        '409':
          description: Template with this name already exists
        '500':
          description: Server error
    get:
      summary: Get all email templates
      responses:
        '200':
          description: Templates retrieved successfully
        '500':
          description: Server error

  /templates/{id}:
    get:
      summary: Get email template by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Template retrieved successfully
        '404':
          description: Template not found
        '500':
          description: Server error
    put:
      summary: Update an email template
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                subject:
                  type: string
                bodyHtml:
                  type: string
                bodyText:
                  type: string
                variables:
                  type: object
                isActive:
                  type: boolean
      responses:
        '200':
          description: Template updated successfully
        '404':
          description: Template not found
        '409':
          description: Template with this name already exists
        '500':
          description: Server error
    delete:
      summary: Delete an email template
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Template deleted successfully
        '404':
          description: Template not found
        '500':
          description: Server error

  /preferences:
    get:
      summary: Get user notification preferences
      parameters:
        - name: userId
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Preferences retrieved successfully
        '400':
          description: Invalid request
        '500':
          description: Server error
    post:
      summary: Create a notification preference
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
                - notificationType
              properties:
                userId:
                  type: string
                notificationType:
                  type: string
                emailEnabled:
                  type: boolean
                  default: true
                smsEnabled:
                  type: boolean
                  default: false
                pushEnabled:
                  type: boolean
                  default: true
      responses:
        '201':
          description: Preference created successfully
        '400':
          description: Invalid request
        '409':
          description: Preference already exists
        '500':
          description: Server error
    put:
      summary: Update user notification preferences
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
                - notificationType
              properties:
                userId:
                  type: string
                notificationType:
                  type: string
                emailEnabled:
                  type: boolean
                smsEnabled:
                  type: boolean
                pushEnabled:
                  type: boolean
      responses:
        '200':
          description: Preference updated successfully
        '400':
          description: Invalid request (security notifications cannot be modified)
        '500':
          description: Server error

  /preferences/{userId}/{notificationType}:
    get:
      summary: Get user notification preference by type
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
        - name: notificationType
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Preference retrieved successfully (returns default if not found)
        '500':
          description: Server error

# This service primarily consumes events from SQS/SNS
# Event-driven notifications are handled automatically
# API endpoints are available for manual notification sending and management

