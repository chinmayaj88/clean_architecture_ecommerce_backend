// Notification Service Database Schema
// Handles notifications, email templates, notification preferences, and delivery logs

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Notification records (emails, SMS, push, in-app)
model Notification {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  type          NotificationType
  templateId    String?   @map("template_id")
  subject       String?
  body          String
  status        NotificationStatus @default(PENDING)
  metadata      Json?
  scheduledAt   DateTime? @map("scheduled_at")
  sentAt        DateTime? @map("sent_at")
  deliveredAt   DateTime? @map("delivered_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  template      EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  logs          NotificationLog?

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([userId, status, createdAt])
  @@index([status, scheduledAt])
  @@map("notifications")
}

// Email template definitions
model EmailTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  subject   String
  bodyHtml  String   @map("body_html")
  bodyText  String?  @map("body_text")
  variables Json?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  notifications Notification[]

  @@map("email_templates")
}

// User notification preferences
model NotificationPreference {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  notificationType String   @map("notification_type")
  emailEnabled     Boolean  @default(true) @map("email_enabled")
  smsEnabled       Boolean  @default(false) @map("sms_enabled")
  pushEnabled      Boolean  @default(true) @map("push_enabled")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@unique([userId, notificationType])
  @@index([userId])
  @@map("notification_preferences")
}

// Notification delivery logs and provider responses
model NotificationLog {
  id                String   @id @default(cuid())
  notificationId    String   @unique @map("notification_id")
  status            NotificationLogStatus
  provider          String
  providerMessageId String?  @map("provider_message_id")
  providerResponse  Json?    @map("provider_response")
  error             String?
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  notification      Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@map("notification_logs")
}

// Enums
enum NotificationType {
  EMAIL
  SMS
  PUSH
  IN_APP

  @@map("notification_type")
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED

  @@map("notification_status")
}

enum NotificationLogStatus {
  SENT
  DELIVERED
  FAILED
  BOUNCED

  @@map("notification_log_status")
}



